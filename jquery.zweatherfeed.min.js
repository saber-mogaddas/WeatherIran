
(function ($) {
    var row = 'odd'; $.fn.weatherfeed = function (locations, options) {
        var defaults = { unit: 'c', image: true, highlow: true, wind: true, link: true, showerror: true }; var options = $.extend(defaults, options); return this.each(function (i, e) {
            var $e = $(e); if (!$e.hasClass('weatherFeed')) $e.addClass('weatherFeed'); if (!$.isArray(locations)) return false; var count = locations.length; if (count > 10) count = 10; var locationid = ''; for (var i = 0; i < count; i++) { if (locationid != '') locationid += ','; locationid += "'" + locations[i] + "'"; }
            now = new Date()
            var query = "select * from weather.forecast where location in (" + locationid + ") and u='" + options.unit + "'"; var api = 'http://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent(query) + '&rnd=' + now.getFullYear() + now.getMonth() + now.getDay() + now.getHours() + '&format=json&callback=?'; $.ajax({ type: 'GET', url: api, dataType: 'json', success: function (data) { if (data.query) { if (data.query.results.channel.length > 0) { var result = data.query.results.channel.length; for (var i = 0; i < result; i++) { _callback(e, data.query.results.channel[i], options); } } else { _callback(e, data.query.results.channel, options); } } else { if (options.showerror) $e.html('<p>Weather information unavailable</p>'); } }, error: function (data) { if (options.showerror) $e.html('<p>Weather request failed</p>'); } });
        });
    }; var _callback = function (e, feed, options) {
        var $e = $(e); var wd = feed.wind.direction; if (wd >= 348.75 && wd <= 360) { wd = "شمال" }; if (wd >= 0 && wd < 11.25) { wd = "شمال" }; if (wd >= 11.25 && wd < 33.75) { wd = "شمال شرقی" }; if (wd >= 33.75 && wd < 56.25) { wd = "شمال شرقی" }; if (wd >= 56.25 && wd < 78.75) { wd = "شمال شرقی" }; if (wd >= 78.75 && wd < 101.25) { wd = "شرقی" }; if (wd >= 101.25 && wd < 123.75) { wd = "جنوب شرقی" }; if (wd >= 123.75 && wd < 146.25) { wd = "جنوب شرقی" }; if (wd >= 146.25 && wd < 168.75) { wd = "جنوب شرقی" }; if (wd >= 168.75 && wd < 191.25) { wd = "جنوب" }; if (wd >= 191.25 && wd < 213.75) { wd = "جنوب غربی" }; if (wd >= 213.75 && wd < 236.25) { wd = "جنوب غربی" }; if (wd >= 236.25 && wd < 258.75) { wd = "جنوب غربی" }; if (wd >= 258.75 && wd < 281.25) { wd = "غرب" }; if (wd >= 281.25 && wd < 303.75) { wd = "شمال غربی" }; if (wd >= 303.75 && wd < 326.25) { wd = "شمال غربی" }; if (wd >= 326.25 && wd < 348.75) { wd = "شمال غربی" }; var wf = feed.item.forecast[0]; wpd = feed.item.pubDate; n = wpd.indexOf(":"); tpb = _getTimeAsDate(wpd.substr(n - 2, 8)); tsr = _getTimeAsDate(feed.astronomy.sunrise); tss = _getTimeAsDate(feed.astronomy.sunset); if (tpb > tsr && tpb < tss) { daynight = 'd'; } else { daynight = 'n'; }
        var html = '<div class="weatherItem ' + row + '"'; if (options.image) html += ' style="background-image: url(); background-repeat: no-repeat;"'; html += '>';html +='<img src="http://l.yimg.com/a/i/us/nws/weather/gr/' + feed.item.condition.code + daynight + '.png" alt="">'; html += '<div class="weatherCity">' + feed.location.city + '</div>'; html += '<div class="weatherTemp">' + feed.item.condition.temp + '&deg;</div>'; if (options.highlow) html += '<div class="weatherRange">حداکثر دما: ' + wf.high + '&deg; حداقل دما: ' + wf.low + '&deg;</div>'; if (options.wind) html += '<div class="weatherWind">سرعت و جهت باد: ' + wd + ' ' + feed.wind.speed + feed.units.speed + '</div>';  html += '</div>'; if (row == 'odd') { row = 'even'; } else { row = 'odd'; }
        $e.append(html);
    }; var _getTimeAsDate = function (t) { d = new Date(); r = new Date(d.toDateString() + ' ' + t); return r; };
})(jQuery);